import{x as t}from"./modules/compat.js";import{Y as e}from"./modules/YearAwareComponent.js";import{R as a}from"./modules/roomService.js";import{D as s}from"./modules/developmentService.js";import"./modules/apiService.js";const i="wishlist_ids";function r(){try{const t=JSON.parse(localStorage.getItem(i)||"[]");return Array.isArray(t)?t:[]}catch{return[]}}function o(){return[...r()]}const l="change-document-control-class";function n(t){document.body.dataset.activeTray=t}function c(t){d(t)&&(document.body.dataset.activeTray="")}function d(t){return t===document.body.dataset.activeTray}function m(t,e="toggle"){document.dispatchEvent(new CustomEvent(l,{detail:{controlClass:t,action:e}}))}const h="wishlist-tray";class p extends e{#t;#e;#a;constructor(t){super(t);const e=o(),i=e;this.state={activeYear:this.getActiveYear(),codesInWishlist:e,codesInTray:i,roomsData:{},developmentsData:{}},this.#e=new a,this.#a=new s}async componentDidMount(){await this.#s(),await this.#i(),this.#t=new AbortController;const t=this.#t.signal;document.addEventListener(l,this.#r.bind(this),{signal:t}),window.addEventListener("storage",this.#o.bind(this),{signal:t}),window.addEventListener("wishlist-updated",this.#l.bind(this),{signal:t})}componentWillUnmount(){this.#t.abort()}componentDidUpdate(t,e){e.codesInWishlist!==this.state.codesInWishlist&&this.#s(),e.roomsData!==this.state.roomsData&&this.#i()}render(){const e=this.state.codesInWishlist.length,a=String(this.props.textTrayTitle??""),s=String(0===e?this.props.textTrayIntroEmpty:this.props.textTrayIntro);return t.createElement("div",{className:"vita-wishlist-tray__inner","data-is-empty":0===e?1:0},this.#n(),t.createElement("div",{className:"vita-wishlist-tray__overlay",onClick:this.#c.bind(this)}),t.createElement("div",{className:"vita-wishlist-tray__tray"},t.createElement("div",{className:"vita-wishlist-tray__header"},t.createElement("h3",{className:"vita-wishlist-tray__title"},a),t.createElement("p",{className:"vita-wishlist-tray__intro"},s)),t.createElement("div",{className:"vita-wishlist-tray__track"},t.createElement("ul",{className:"vita-wishlist-tray__grid"},Array.from({length:8}).map(((e,a)=>{const s=this.state.codesInTray[a],i=!s;return t.createElement("li",{key:a,"data-empty":i?"1":"0",className:"vita-wishlist-tray__slot"},!i&&this.#d(s))}))))))}#n(){return t.createElement("div",{className:"vita-wishlist-tray__toggle",onClick:this.#m.bind(this)},t.createElement("svg",{className:"vita-wishlist-tray__toggle-effect",width:"23",height:"20",viewBox:"0 0 23 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},t.createElement("path",{d:"M11.9415 18.5L3.44131 10.6298C-1.19131 5.9715 5.56635 -3.04726 11.9415 4.24858C18.3166 -3.02599 25.138 5.99277 20.4417 10.6298L11.9415 18.5Z","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})),t.createElement("svg",{className:"vita-wishlist-tray__toggle-heart",width:"23",height:"20",viewBox:"0 0 23 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},t.createElement("path",{d:"M11.9415 18.5L3.44131 10.6298C-1.19131 5.9715 5.56635 -3.04726 11.9415 4.24858C18.3166 -3.02599 25.138 5.99277 20.4417 10.6298L11.9415 18.5Z","stroke-width":"1","stroke-linecap":"round","stroke-linejoin":"round"})),t.createElement("div",{className:"vita-wishlist-tray__chip"}))}#d(e){if(!Reflect.has(this.state.roomsData,e))return;const a=Reflect.get(this.state.roomsData,e);if(!Reflect.has(this.state.developmentsData,a.development_id))return;const s=Reflect.get(this.state.developmentsData,a.development_id),i=String(this.props.textViewRoom??""),r=String(this.props.textSeeOtherOptions??""),o=a?.images.find((t=>"string"==typeof t&&""!==t.trim())),l="Available"!==a.status,n=l?r:i,c=String(this.props.textSoldOut??""),d=String(s.link??""),m=l?d:d+String(a.url??"");return t.createElement("div",{className:"vita-wishlist-tray__room-card wl-roomcard","data-sold-out":l?"1":"0"},t.createElement("div",{className:"wl-roomcard__header"},m&&o&&t.createElement("a",{href:m,className:"wl-roomcard__thumbnail"},t.createElement("img",{src:o})),t.createElement("add-to-wishlist",{"data-room-id":e,"data-text-add-to-wishlist":String(this.props.textAddToWishlist??""),"data-text-remove-from-wishlist":String(this.props.textRemoveFromWishlist??""),"data-text-wishlist-full":String(this.props.textWishlistFull??"")})),t.createElement("ul",{className:"wl-roomcard__details"},t.createElement("li",{className:"wl-roomcard__detail wl-roomcard__detail--type"},a.room_name),!l&&t.createElement("li",{className:"wl-roomcard__detail wl-roomcard__detail--price"},t.createElement("span",null,a.price)),l&&t.createElement("li",{className:"wl-roomcard__detail wl-roomcard__detail--sold-out"},t.createElement("span",null,c)),t.createElement("li",{className:"wl-roomcard__detail wl-roomcard__detail--building"},a.development),t.createElement("li",{className:"wl-roomcard__detail wl-roomcard__detail--code"},a.code)),m&&t.createElement("div",{className:"wp-block-button"},t.createElement("a",{className:"wp-block-button__link",href:m},n)))}async#s(){const t=Array.isArray(this.state.codesInTray)?this.state.codesInTray:[],e=Array.isArray(this.state.codesInWishlist)?this.state.codesInWishlist:[],a=[...new Set([...t,...e])],s=Object.keys(this.state.roomsData),i=a.filter((t=>!s.includes(t)));if(0===i.length)return;const r=i.map((t=>this.#e.getRoom(t,this.state.activeYear))),o=(await Promise.allSettled(r)).filter((t=>"fulfilled"===t.status)).map((t=>t.value)).filter((t=>Array.isArray(t)&&0<t.length)).map((t=>t[0]));if(0===o.length)return;const l=o.reduce(((t,e)=>(e?.code&&(t[e.code]=e),t)),{});this.setState((t=>({roomsData:{...t.roomsData,...l}})))}async#i(){const t=Array.from(new Set(Object.values(this.state.roomsData).map((t=>t?.development_id)).filter(Boolean).map(String))),e=Object.keys(this.state.developmentsData),a=t.filter((t=>!e.includes(t)));if(0===a.length)return;const s=a.map((t=>this.#a.getDevelopmentByAlgoliaId({developmentCode:t}))),i=(await Promise.allSettled(s)).filter((t=>"fulfilled"===t.status)).map((t=>t.value));if(0===i.length)return;const r=i.reduce(((t,e)=>(e?.acf?.development_id&&(t[e.acf.development_id]=e),t)),{});this.setState((t=>({developmentsData:{...t.developmentsData,...r}})))}#r(t){const e=String(t.detail.controlClass??"");let a=String(t.detail.action??"toggle");switch(e!==h&&(a="close"),a){case"open":n(h);break;case"close":c(h);break;case"toggle":!function(t){document.body.dataset.activeTray===t?c(t):n(t)}(h)}}async#o(t){if(t.key!==i)return;const e=o();let a;a=d(h)?Array.from(new Set([...this.state.codesInTray,...e])):e,this.setState({codesInWishlist:e,codesInTray:a})}async#l(t){const e=o();let a;a=d(h)?Array.from(new Set([...this.state.codesInTray,...e])):e,this.setState({codesInWishlist:e,codesInTray:a})}#m(){m(h,"toggle")}#c(){m(h,"close")}}[...document.querySelectorAll("#wishlist-tray-app")].forEach((e=>{const a=e.dataset;t.render(t.createElement(p,a),e)}));
